version: '3.8'

x-common-env: &common-env
  # Core
  LONGBOW_NODE_ID: node1
  LONGBOW_LOG_LEVEL: info
  LONGBOW_LISTEN_ADDR: 0.0.0.0:3000
  LONGBOW_META_ADDR: 0.0.0.0:3001
  LONGBOW_METRICS_ADDR: 0.0.0.0:9090
  LONGBOW_DATA_PATH: /data
  
  # HNSW & Indexing (Pragmas)
  LONGBOW_HNSW_M: 16
  LONGBOW_HNSW_EF_CONSTRUCTION: 200
  LONGBOW_HNSW_ALPHA: 1.2
  LONGBOW_HNSW_KEEP_PRUNED: "false"
  LONGBOW_USE_HNSW2: "true"
  LONGBOW_HNSW_SQ8_ENABLED: "false"
  LONGBOW_HNSW_FLOAT16_ENABLED: "false"
  
  # Memory & GC
  LONGBOW_MAX_MEMORY: 4294967296 # 4GB
  LONGBOW_GOGC: 100
  LONGBOW_GC_BALLAST_G: 1
  
  # Storage & Persistence
  LONGBOW_STORAGE_ASYNC_FSYNC: "true"
  LONGBOW_STORAGE_USE_DIRECT_IO: "false"
  LONGBOW_SNAPSHOT_INTERVAL: 1h
  LONGBOW_MAX_WAL_SIZE: 104857600 # 100MB
  
  # gRPC Tuning
  LONGBOW_GRPC_MAX_RECV_MSG_SIZE: 536870912
  LONGBOW_GRPC_MAX_SEND_MSG_SIZE: 536870912
  
  # Hybrid Search
  LONGBOW_HYBRID_SEARCH_ENABLED: "false"
  LONGBOW_HYBRID_TEXT_COLUMNS: text
  LONGBOW_HYBRID_ALPHA: 0.5

services:
  # Single Instance / Primary Node
  longbow:
    build: .
    # image: ghcr.io/23skdu/longbow:latest
    container_name: longbow
    environment:
      <<: *common-env
      LONGBOW_GOSSIP_ENABLED: "false" # Disabled for one-instance mode
    ports:
      - "3000:3000" # Data Plane
      - "3001:3001" # Control Plane
      - "9090:9090" # Metrics
    volumes:
      - ./data/longbow:/data
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

networks:
  default:
    name: longbow-net
    driver: bridge
